name: CI

on:
    pull_request:
    push:
        branches:
            - master
    workflow_dispatch:

jobs:
    validation:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php-version: [
                        '8.3',
                        '8.4'
                ]

        steps:
            - uses: actions/checkout@v4

            - name: Validate composer.json and composer.lock
              run: composer validate

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v4
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  extensions: mbstring, intl, pdo_mysql

            - name: Composer install
              run: |
                  composer --version
                  composer install -o

            - name: Debug transfer generation
              run: |
                  echo "=== Checking transfer XML schemas ==="
                  find src -name "*.transfer.xml" 2>/dev/null || echo "No transfer XMLs in src/"
                  find tests/app -name "*.transfer.xml" 2>/dev/null || echo "No transfer XMLs in tests/app/"
                  echo "=== Checking vendor transfer schemas ==="
                  find vendor/spryker/*/src/*/Shared/*/Transfer -name "*.transfer.xml" 2>/dev/null | head -20 || echo "No vendor transfer XMLs"
                  echo "=== Running transfer generation manually ==="
                  php -r "
                  require 'vendor/autoload.php';
                  require 'tests/bootstrap.php';
                  if (!defined('APPLICATION_SOURCE_DIR')) define('APPLICATION_SOURCE_DIR', APPLICATION_ROOT_DIR . 'src/');
                  if (!defined('MODULE_UNDER_TEST_ROOT_DIR')) define('MODULE_UNDER_TEST_ROOT_DIR', realpath(__DIR__) . '/');
                  echo 'APPLICATION_ROOT_DIR: ' . APPLICATION_ROOT_DIR . PHP_EOL;
                  echo 'APPLICATION_SOURCE_DIR: ' . APPLICATION_SOURCE_DIR . PHP_EOL;
                  echo 'APPLICATION_VENDOR_DIR: ' . APPLICATION_VENDOR_DIR . PHP_EOL;
                  echo 'MODULE_UNDER_TEST_ROOT_DIR: ' . MODULE_UNDER_TEST_ROOT_DIR . PHP_EOL;
                  try {
                      \$facade = new \Spryker\Zed\Transfer\Business\TransferFacade();
                      \$facade->generateTransferObjects(new \Psr\Log\NullLogger());
                      echo 'Transfer generation SUCCESS' . PHP_EOL;
                  } catch (\Throwable \$e) {
                      echo 'Transfer generation FAILED: ' . \$e->getMessage() . PHP_EOL;
                      echo \$e->getTraceAsString() . PHP_EOL;
                  }
                  "
                  echo "=== Generated transfer files ==="
                  find tests/app/src/Generated -name "*.php" 2>/dev/null | head -20 || echo "No generated transfers found"

            - name: Run tests
              run: composer test

            - name: PHPStan checks
              run: |
                  composer stan-setup
                  composer stan

            - name: CodeStyle checks
              run: composer cs-check


    prefer-lowest:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php-version: [
                        '8.3'
                ]

        steps:
            - uses: actions/checkout@v4

            - name: Validate composer.json and composer.lock
              run: composer validate

            - name: Get Composer Cache Directory
              id: composer-cache
              run: |
                  echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v4
              with:
                  path: ${{ steps.composer-cache.outputs.dir }}
                  key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-composer-

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  extensions: mbstring, intl, pdo_mysql

            - name: Composer prefer lowest
              run: composer update --prefer-lowest --prefer-stable

            - name: Run tests
              run: composer test
